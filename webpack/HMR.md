**热模块替换**（Hot Module Replacement，简称 HMR）是一种在不刷新整个页面的情况下，替换、更新或删除模块的技术。它是现代 Web 开发工具中的一项重要功能，通常在开发模式下使用。Webpack 和其他构建工具（如 Vite）都支持 HMR。

热模块替换的原理主要是**通过 Webpack 监控代码的变化，当我们修改了某一模块，只需要重新打包编译当前模块，其他模块不变**。

-  在 devServer 中开启 hot：true



#### 实现流程

- **监控文件变化**
  - Webpack 会监控项目文件夹中的源代码文件（通常是 JavaScript、CSS、图片等），通过 Webpack 的 `devServer` 来监听文件的变化。一旦检测到文件内容发生变化，Webpack 会在后台进行重新编译。
  - Webpack 会在内存中生成一个映射（`HMR Manifest`），这个映射包含了每个模块和其依赖关系的信息。当某个文件被修改时，Webpack 会生成新的模块文件，并将它与旧的模块进行对比，找出变化的模块。
- **建立 websocket 连接**
  - Webpack-dev-server 会启动一个 WebSocket 服务器，并将这个 WebSocket 连接注入到页面中。通过这个 WebSocket 连接，Webpack 可以将实时编译的模块推送到浏览器
- **模块更新通知**
  - 当 Webpack 编译完成，并且有更新的模块时，它会通过 WebSocket 连接将信息推送到浏览器端。浏览器端会收到一个更新通知，告知哪些模块发生了变化。当然服务端传递的最主要信息还是新模块的`hash`值，后面的步骤根据这一`hash`值来进行模块热替换
- **替换模块**
  - 当浏览器接收到更新通知后，浏览器端会通过 HMR 客户端代码来替换更新的模块。替换模块的过程如下：
    - **更新模块：** HMR 会尝试更新修改过的模块并保持其他模块的状态不变。对于 JavaScript 模块，HMR 会将新的 JavaScript 代码加载到浏览器，并用新的模块替换旧的模块。
    - **替换 CSS/样式：** 对于 CSS 文件，HMR 会动态更新样式，而不会刷新整个页面。修改过的样式会立即应用到页面中。
    - **更新不需要刷新页面的状态：** 如果有不涉及状态变更的部分（比如 UI、组件结构等），Webpack 会避免页面的完全刷新，保持用户的输入、滚动位置等不变。



#### Vite HMR

- **快速构建**：通过 `esbuild` 提供快速编译和热更新。

- **基于原生 ESM**：利用浏览器对 ES 模块的原生支持，实现按需加载和更新。
- **WebSocket 通信**： Vite 利用 WebSocket 通信来实现浏览器和开发服务器之间的实时双向通信。服务器通过 WebSocket 连接将更新通知发送到浏览器，浏览器接收到通知后，替换相应的模块并更新页面。
  - 对于 JavaScript 模块，Vite 会使用 `import` 替换更新的模块，而对于 CSS 模块，它会替换样式，而不刷新页面。
  - 如果是像 React 这样的框架，Vite 会通过框架特定的 HMR API（如 React Fast Refresh）来只更新受影响的组件，保持应用的状态。
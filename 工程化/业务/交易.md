## 交易

从 TTCM 开始以来，因为海外交易的特殊性与复杂性，一直都是依赖于客户线下给达人打款的形式。

这种方式虽然能够有效避开以上的合规问题，但是也进一步带来了诸如，客户滥用平台、打款无规则无保障、订单处置随意的问题，进而导致数据无法回收、流程不能闭环。且并不是所有的达人与客户都能快速找到合适的打款方式，因而交易能力对平台来说具有十分重要的意义。



PIPO 结算模式：

自营：碰钱，技术方案+资金管理，ROW

托管：不碰钱，仅提供技术方案，美国，欧洲，巴西，加拿大，入驻的时候是在渠道那边建立一个真实账号



Gross（有点像托管，GB，FR）：

TCM 和 pipo 签约，pipo 和渠道（比如paypal）签约，pipo 在渠道那边有账户，钱实际是存到渠道那边，提现也是从渠道那边扣款到银行卡，TCM 感知不到渠道（美国只有 stripe）

Net （其他国家）：

达人信息都在本地机房

广告主只有余额支付时才需要入驻 pipo



合作方：

- 3M：与交易相关的主要是3M的资金平台，我们**通过他们的主订单、分成等服务进行下单，冻结金额、分成打款等操作**，可以认为3M给TCM提供给了TCM客户线上交易的能力，3M再与下游PIPO，计费等交互，来完成整个交易流程。3M是我们的直接对接方，关系最为密切
- PIPO  国际支付：提供专业的海外支付解决方案，帮助业务畅通支付渠道
  
- 3M底层也是用的国际支付，但是3m会为多个业务线比如promote什么的服务，所以他们会在国际支付上再包装一层，更利于我们使用，3M 还有销售业绩开票什么的逻辑
- 只有达人/广告主开商户号和达人提现这些是直接和PIPO对接，大部分还是先过3M



提现方式：

- 自助提现

- 周期提现

- 一步提现 （BR）

  

风险问题：

- 金额计算类问题
  - 金额计算必须使用标准工具包toolbox的Money包。
  - 不要在前端进行任何金额计算。
  - 确认计算单位是否对齐、币种转换、类型转换是否正确、类型存储是否会溢出、截断方式（上下取整、舍入规则、保留位数）是否正确。
  
- 一致性问题
  - 上下游金额单位一致：需要明确具体的金额单位，是否符合 ISO 标准：
  - 上下游订单状态同步：监听回调，事后核对（实时核对，离线核对）
  
- 风控合规（RFI：Request for information)
  - 渠道询单：外部银行/第三方支付服务商认为某笔订单存在合规等风险时，通过邮件知会pipo获取交易的上下文信息(如交易人信息、交易目的等)，以判断交易是否可以继续开展
  
  - 实时 RFI：制裁实时扫描在交易/绑卡阶段，如果根据用户姓名判断存在风险但其他信息不足时，通过交易链路实时下发信息收集页面辅助更进一步降低 交易拒绝的概率；
  





订单支付时：

- 传入金额，单位，税等以及风控参数，通过后端接口获取收银台链接
- 吊起收银台 sdk，通过嵌入式弹窗的方式唤起收银台
  - 3M 收银台 web sdk：集成了支付，卡管理，绑卡，换绑，支付码等功能
  - 出于性能方面的考虑，在使用收银台之前进行动态加载，按照机房引入对应的 sdk js 资源
  - 传入收银台链接，并监听 sdk 事件执行回调
    - upay_did_mount：收银台初始化完成
    - upay_status_result: 支付是否成功
      - status：是否成功
      - clickBtn：是否点击 back 按钮关闭弹窗
      - actionType：结果来源，bind 绑卡，pay 支付，change 支付方式变更
    - upay_modal_cance: 取消支付




## 白屏检测

**执行时间：**

- window.load: 在整个页面及所有依赖资源如样式表和图片都已完成加载时触发
- document.DOMContentLoaded: 只要页面 DOM 加载完成就触发，无需等待依赖资源的加载 （不会等待图片、子框架和异步脚本等其他内容完成加载）

**原理：**

1. 页面 load 完成之后等待一个 ric（requestIdleCallback） 和 raf（requestAnimationFrame），开始用 MutationObserver 监听 Dom 变化，并在回调中触发白屏检测事件
2. 每次 Dom 发生变更，调度一次打分任务，时间在一个 ric 和一个 raf 之后。
3. 每次 Dom 发生变更，或者网络请求数大于1，且当前有正在调度中的打分任务，将该打分任务延后一个 ric 和一个 raf 的时间。
4. 每次发现打分小于阈值时（默认 1.5 分），会进行等待回测，具体回测逻辑是: 两秒内没有其他类型的事件上报。回测验证成功后会去加载 html2canvas 的脚本，加载完成后截图并上报白屏事件及截图(base64)。若页面关闭时还没有截屏，则只上报白屏事件。
5. 触发白屏至上报的期间内，若 Dom 再次发生变更且打分大于阈值，若上一次回测未结束，则取消这次白屏，并入上一次回测。若上一次回测已结束且回测失败，重新开始回测。

**打分：**

从 document.body 或通过 rootSelect 指定根元素开始遍历 Dom 树，每次遍历到一个可见 Dom 元素

score = {1 /  2 ^ {depth - 1}}

计一个分数：（depth 为该元素相对根元素深度）。仅遍历 4层深度，当总分达到阈值（默认为 1.5）时停止遍历。

该操作很快就会停止遍历，所以耗时很小

**回测：**减少白屏误报率

在回测周期内没有事件上报（js error / 请求异常 / 资源异常 / PV 等行为事件）则页面稳定，上报白屏

回测周期：首屏 8s，非首屏 2s

（近似描述，如果在触发检测时  performance.now(）（降级方案是Date.now()-timing.navigationStart）的值大于10秒，那么观察的窗口期就定为2秒，否则定为8秒。在首屏场景下，这个时间通常会小于10秒。在非首屏场景下，页面使用的时间更长，这个时间通常会大于10秒。）


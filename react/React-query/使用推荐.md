## queryKey å¦‚ä½•ç¡®å®š

Bam åœ¨ç”Ÿæˆä»£ç çš„æ—¶å€™ï¼ŒåŒæ—¶ç”Ÿæˆäº†ä¸€ä¸ª service.ts æ–‡ä»¶ï¼Œåœ¨å®šä¹‰ä¸€ä¸ª react query hook çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸ªå¯¹è±¡ã€‚

æ¯”å¦‚è¯´ç°åœ¨æœ‰ä¸€ä¸ªè·å– shortlist react query hookï¼š

1. å®ƒæ˜¯è°ƒç”¨ `mQueryShortlist`æ–¹æ³•ï¼ŒqueryKey å°±å¯ä»¥è¯»å– `ClientAssetService.MQueryShortlist`ï¼Œè¿™ä¸¤ä¸ªçš„åŒºåˆ«åªæœ‰**å¤§å°å†™ï¼Œåœ¨ä¸è€ƒè™‘å¤§å°å†™çš„æƒ…å†µä¸‹ï¼Œä»–ä»¬ä¸¤ä¸ªä¸€å®šæ˜¯ç»Ÿä¸€èµ·æ¥çš„**ã€‚
2. å¦‚æœæœ‰å‚æ•°çš„è¯ï¼ŒæŠŠå‚æ•°æ”¾åˆ° queryKey é‡Œé¢ã€‚
3. æœ€ç»ˆçš„ queryKey å°±æ˜¯ `[``ClientAssetService.MQueryShortlist``, ``params``]`

```TypeScript
const useGetAllShortlist = <T = QueryFnReturnType>(
  params?: MQueryShortlistRequest,
  options: UseGetAllShortlistOptions<T> = {},
) => {
  return useQuery<QueryFnReturnType, unknown, T | null>({
    ...options,
    queryKey: [ClientAssetService.MQueryShortlist, params],
    queryFn: () => mQueryShortlist(params),
    staleTime: 1000 * 60,
    placeholderData: keepPreviousData,
  });
};
```

**Mutation Key ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œæ¨èåœ¨ useMutation çš„æ—¶å€™ä¹ŸåŠ ä¸Š mutation Keyï¼Œæ–¹ä¾¿åœ¨ devtools ä¸­æ’æŸ¥åˆ°ã€‚**

```TypeScript
const useEditShortlist = () => {
  return useMutation({
    mutationKey: [ClientAssetService.EditShortlist], // ä¸éœ€è¦å†™ pararms
    mutationFn: (params: EditShortlistRequest) => editShortlist(params),
  });
};
```



## å¼€å‘å°æŠ€å·§ï¼šreact query devtools

æˆ‘ä»¬éœ€è¦é¢‘ç¹çš„æ”¹ä»£ç åˆ·æ–°é¡µé¢è°ƒç”¨æ¥å£ï¼Œæœ‰äº† react query devtools çš„è¯ï¼Œå†ä¹Ÿä¸ç”¨è¿™ä¹ˆéº»çƒ¦äº†ã€‚

æ ¹æ® react query ä¸­çš„æ–‡æ¡£ï¼Œå…ˆå®‰è£…ä¾èµ–

```Bash
$ npm i @tanstack/react-query-devtools
# or
$ pnpm add @tanstack/react-query-devtools
# or
$ yarn add @tanstack/react-query-devtools
# or
$ bun add @tanstack/react-query-devtools
```

ç„¶åå¯¼å…¥ä¾èµ–ä¹‹åï¼Œå°†å®ƒæ”¾åˆ°æ ¹èŠ‚ç‚¹

```TypeScript
import { ReactQueryDevtools } from "@tanstack/react-query-devtools";

function App() {
  return (
    <QueryClientProvider client={queryClient}>
      {/* The rest of your application */}
      <ReactQueryDevtools initialIsOpen={false} />
    </QueryClientProvider>
  );
}
```

å…·ä½“çš„é…ç½®å‚æ•°å¯ä»¥[æŸ¥çœ‹æ–‡æ¡£](https://tanstack.com/query/latest/docs/framework/react/devtools)ã€‚



## Demo Todo

ä¸ºäº†æ–¹ä¾¿å¤§å®¶ç†è§£ï¼Œä½¿ç”¨æœ€ç»å…¸çš„ Todo demoï¼Œuiå¦‚ä¸‹ã€‚

1. Input è¿›è¡Œåˆ›å»ºä¸€ä¸ª Todo
2. List å¯ä»¥åˆ é™¤ã€å®Œæˆtodo
3. ItemsLeft å¯ä»¥ç­›é€‰ todoï¼Œä»¥åŠç»Ÿè®¡å½“å‰çš„ todo æ•°é‡

## å„ç§çŠ¶æ€

React query çš„ä¸¤ä¸ª hook è¿”å›äº†å„ç§å„æ ·çš„çŠ¶æ€ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬ç”¨çš„æ¯”è¾ƒå¤šçš„åªæœ‰å‡ ä¸ªã€‚

### useQuery

- `isSuccess`: æŸ¥è¯¢æˆåŠŸäº†ï¼Œå·²ç»æœ‰`data`
- `isError`ï¼šæŸ¥è¯¢ä¸èµ·ä½œç”¨ï¼Œå¹¶ä¸”`error`å·²è®¾ç½®
- `isPening`: æŸ¥è¯¢æ²¡æœ‰æ•°æ®

è¯·æ³¨æ„ï¼Œè¯¥`isFetching / isFetchingNextPage`æ ‡å¿—ä¸æ˜¯*å†…éƒ¨*çŠ¶æ€æœºçš„ä¸€éƒ¨åˆ† - å®ƒæ˜¯ä¸€ä¸ªé™„åŠ æ ‡å¿—ï¼Œ**åªè¦è¯·æ±‚æ­£åœ¨è¿›è¡Œï¼Œè¯¥æ ‡å¿—å°±ä¼šä¸ºçœŸ**ã€‚

```TypeScript
function Todos() {
  const { isPending, isError, data, error } = useQuery({
    queryKey: ['todos'],
    queryFn: fetchTodoList,
  })

  if (isPending) {
    return <span>Loading...</span>
  }

  if (isError) {
    return <span>Error: {error.message}</span>
  }

  return (
    <ul>
      {data.map((todo) => (
        <li key={todo.id}>{todo.title}</li>
      ))}
    </ul>
  )
}
```

### useMutation

- isPendingï¼šæ­£åœ¨æ‰§è¡Œ mutation
- isSuccessï¼šmutation æ˜¯å¦æ‰§è¡ŒæˆåŠŸ

```TypeScript
const mutation = useMutation({
  mutationFn: (newTodo) => {
     return axios.post('/todos', newTodo)
  },
})
  
mutation.mutateAsync();
```

## å¦‚æœä¸æƒ³æ¯æ¬¡è°ƒç”¨ hook çš„æ—¶å€™è°ƒç”¨æ¥å£

åœ¨ä¸Šé¢ Todo Demo ä¸­ï¼Œåœ¨ Listã€ItemsLeft ç»„ä»¶éƒ½ä¼šè·å– todos æ•°ç»„ï¼Œæ‰€ä»¥æˆ‘å°è£…äº†ä¸€ä¸‹è¿™ä¸ªhookï¼Œå†…å®¹ä¹Ÿå¾ˆç®€å•ã€‚

```TypeScript
const useGetTodos = (position: string) => {
  const { filter } = useFilter();
  return useQuery<TodoPagination>({
    queryKey: ["todos", { filter }],
    queryFn: () => {
      console.log("useGetTodos position", position);
      return request.get("/todo", { params: { filter } });
    },
  });
};
```

å½“æˆ‘åˆ·æ–°é¡µé¢ä¹‹åä¼šæœ‰ä¸¤ä¸ªæ—¥å¿—ï¼Œè¡¨ç¤º Listã€ItemsLeft éƒ½ä¼šå»è°ƒç”¨ useGetTodos è¯·æ±‚åç«¯æ¥å£ã€‚

> é»˜è®¤æƒ…å†µä¸‹ react query çš„ staleTime æ˜¯ 0 ï¼Œæ‰€ä»¥æ¯å½“åŒä¸€ä¸ª hook å¤šæ¬¡è°ƒç”¨æ—¶ï¼Œæ€»æ˜¯ä¼šè¯·æ±‚æ¥å£ã€‚

React query ä¸­æä¾›äº†ä¸€ä¸ª staleTime å±æ€§ï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯ï¼š**åœ¨å¤šå°‘æ¯«ç§’å†…å‘é€çš„æ¥å£è¯·æ±‚éƒ½èµ°ç¼“å­˜ï¼Œè¶…è¿‡è¿™ä¸ªæ—¶é—´å°±é‡æ–°è¯·æ±‚æ¥å£ã€‚**

è¿™ä¹ˆä¸€è¯´ï¼Œå¯èƒ½ä¸å¤ªæ‡‚ï¼Œæˆ‘ä»¬æ¥æ”¹ä¸€ä¸‹ä»£ç ã€‚

```TypeScript
const useGetTodos = (position: string) => {
  const { filter } = useFilter();
  return useQuery<TodoPagination>({
    // çœç•¥å…¶ä»–çš„å±æ€§
    staleTime: 1000 * 5
  });
};
```

æ·»åŠ çš„ `staleTime``: 1000 * 5`çš„æ„æ€å°±æ˜¯å½“é‡å¤è°ƒç”¨è¿™ä¸ª hooks æ—¶ï¼Œå¦‚æœ 5s ä»¥å†…çš„åŒä¸€ä¸ª query è°ƒç”¨éƒ½ä¸ä¼šè°ƒç”¨æ¥å£ï¼Œè¶…è¿‡ 5s å°±ä¼šé‡æ–°è°ƒç”¨æ¥å£åˆ·æ–°ç¼“å­˜æ•°æ®ã€‚

## æ¨èï¼šå¯¹æ¥å£è¿”å›æ•°æ®åšä¸€å±‚æ•°æ®å¤„ç†ï¼Œå¯ä»¥ä½¿ç”¨ select

å¦‚æœæœ‰å¯¹æ¥å£è¿”å›çš„æ•°æ®åšä¸€å±‚å¤„ç†çš„éœ€æ±‚ï¼Œå¯ä»¥ä½¿ç”¨ select æ–¹æ³•ã€‚

> select æ–¹æ³•åœ¨æ•°æ®æ˜¯ undefined çš„æƒ…å†µä¸‹ä¸ä¼šè¿›è¡Œè°ƒç”¨ã€‚

```TypeScript
useQuery({
  queryFn: () => {
    return [1,2,3,4,5]
  },
  select: (data) => data.filter(v => v > 3)
});

// [4,5]
```

æ¯”å¦‚è¯´ä¸Šé¢ä»£ç å°±åªä¼šè¿”å› `[4,5]`ï¼Œå®ƒåšäº†ä¸€å±‚è¿‡æ»¤ã€‚

```TypeScript
const { data } = useQuery({
  queryFn: () => {
    return [
      { name: "test", count: 1 },
      { name: "test2", count: 2 },
    ];
  },
  select: (data) => data.map((item) => item.name),
});

data; // string[]
```

åŒæ—¶ select èƒ½å¤Ÿè¿”å›æ­£ç¡®çš„ç±»å‹ï¼Œæ¯”å¦‚è¯´ä¸Šé¢é€šè¿‡ select å‡½æ•°å°† `{name: string; count: number}` æˆåŠŸçš„è½¬æ¢æˆä¸€ä¸ª `string[]`ã€‚

## æ¨èï¼šæƒ³è¦åŠ¨æ€å¼€å¯æŸä¸€ä¸ªè¯·æ±‚ï¼Œå¯ä»¥ä½¿ç”¨ enabled

```TypeScript
const [show, setShow] = useState(false);

useQuery({
  queryFn: () => {
    return [1, 2, 3, 4, 5];
  },
  enabled: show,
});

<button onClick={() => setShow(true)}>å¯ç”¨ query </button>;
```

å½“ show ä¸º false çš„æ—¶å€™ï¼Œå¹¶ä¸ä¼šç›´æ¥è°ƒç”¨è¯¥ hookï¼Œåªæœ‰å½“ show ä¸º true çš„æ—¶å€™æ‰ä¼šçœŸæ­£çš„è°ƒç”¨ï¼ŒåŒæ—¶æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨å¼€å‘è€…å·¥å…·æŸ¥çœ‹åˆ° disabled çš„ query ã€‚

### åœºæ™¯ä¸€ï¼šä¾èµ–è¯·æ±‚çš„ query

æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨è¿™ä¸ªå±æ€§å®ç°ä¸€ä¸ªä¾èµ–è¯·æ±‚çš„ query ã€‚

> Copy å®˜ç½‘çš„ä¾‹å­

```TypeScript
// å…ˆè°ƒç”¨ user query
const { data: user } = useQuery({
  queryKey: ['user', email],
  queryFn: getUserByEmail,
})

const userId = user?.id

// è·å–ç”¨æˆ·çš„ projects
const {
  status,
  fetchStatus,
  data: projects,
} = useQuery({
  queryKey: ['projects', userId],
  queryFn: getProjectsByUser,
  // åªæœ‰å½“ userId å­˜åœ¨æ—¶æ‰ä¼šè°ƒç”¨è¯¥ query
  enabled: !!userId,
})
```

## æ¨èï¼šä½¿ç”¨ useMutation å¢åˆ æ”¹æ•°æ®ï¼Œç›¸å…³çš„ query æ•°æ®ä¹Ÿè¦æ›´æ–°

å¦‚æœåœ¨å¢åˆ æ”¹æ•°æ®ä¹‹åï¼Œæƒ³è¦åˆ·æ–°æŸä¸€ä¸ª query çš„æ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨ä¸¤ç§æ–¹å¼è¿›è¡Œæ•°æ®æ›´æ–°ã€‚

æœ€å¸¸è§çš„åœºæ™¯å°±æ˜¯å¢åˆ æ”¹ä¹‹åï¼Œéœ€è¦åˆ·æ–°åˆ—è¡¨é¡µæ•°æ®ã€‚

ä¸¾ä¸ªä¾‹å­ï¼š

åœ¨ç›´æ¥åˆ›å»ºä¸€ä¸ª todoï¼Œåˆ›å»ºå®Œæˆä¹‹åéœ€è¦æ›´æ–° todo åˆ—è¡¨é¡µæ•°æ®ã€‚

```TypeScript
const queryClient = useQueryClient(); // é€šè¿‡ hook æ‹¿åˆ° queryClient
const createTodoMutation = useMutation({
  mutationKey: ["createTodo"],
  mutationFn: (data: Omit<Todo, "id">) => {
    return request.post("/todo", data);
  },
});

const handleSubmit = async () => {
  await createTodo.mutateAsync(todo);
  // æ›´æ–°åˆ—è¡¨é¡µæ•°æ®
};
```

### ä¸è¯·æ±‚æ¥å£

æˆ‘å°±æ˜¯ä¸æƒ³è¯·æ±‚æ¥å£ï¼Œä¸æƒ³å†èŠ±ä¸€ä¸ªç½‘ç»œè¯·æ±‚èµ„æºåœ¨ä¸Šé¢ï¼ˆä»»æ€§ï¼‰ï¼Œå¦‚ä½•åœ¨æœ¬åœ°å°±æ›´æ–°ç¼“å­˜æ•°æ®å‘¢ï¼Ÿ

> setQueryData( queryKeyï¼Œæ–°çš„æ•°æ®ã€æ›´æ–°å‡½æ•° )

```TypeScript
queryClient.setQueryData(["todos", filter], (prevData) => {
  return prevData.concat(newData);
});
```

### è¯·æ±‚æ¥å£

ä¸Šé¢ä¸€äº›é€»è¾‘å®åœ¨æ˜¯ä¸æƒ³å†™ï¼Œæœ‰æ²¡æœ‰ä»€ä¹ˆå·æ‡’çš„æ–¹å¼ï¼Œè¡Œï¼Œé‚£æˆ‘ä»¬é€šè¿‡è¯·æ±‚æ¥å£æ¥æ›´æ–°ç¼“å­˜æ•°æ®ã€‚

ä½¿ç”¨ `invalidateQueries` æ–¹æ³•å°†æŒ‡å®šçš„ queryKey å¤±æ•ˆï¼Œå¤±æ•ˆä¹‹åå°±ä¼šé‡æ–°è¯·æ±‚æ¥å£ã€‚

```TypeScript
queryClient.invalidateQueries({
  queryKey: ["todos", filter],
});
```

è¿˜æœ‰ä¸€ç§æ–¹å¼æ˜¯ä½¿ç”¨ `refetch`æ–¹æ³•ï¼ŒuseQuery ä¼šè¿”å›ä¸€ä¸ª refetch å‡½æ•°ç”¨æ¥è¿›è¡Œæ‰‹åŠ¨è°ƒç”¨çš„åœºæ™¯ã€‚

```TypeScript
const { refetch } = useQuery<TodoPagination>({
  queryKey: ["todos", { filter }],
  queryFn: async () => {
    return request.get("/todo", { params: { filter } });
  },
});

refetch();
```

è¿™ä¸¤ç§è°ƒç”¨æ–¹å¼ï¼Œåªæ˜¯ **queryKey å‚æ•°ä½ç½®**ä¸åŒï¼Œå¯¹äºæ´»è·ƒçš„ query æ²¡æœ‰åŒºåˆ«ã€‚

queryKey å‚æ•°ä¸åŒå•¥æ„æ€ï¼š

1. invalidateQueries çš„ queryKey å‚æ•°åœ¨ä½¿ç”¨çš„åœ°æ–¹ã€‚

```TypeScript
queryClient.invalidateQueries({
  queryKey: ["todos", { filter }], // å‚æ•°åœ¨å£°æ˜çš„åœ°æ–¹
});
```

1. refetch çš„ queryKey å‚æ•°åœ¨å£°æ˜çš„åœ°æ–¹ã€‚

```TypeScript
const { refetch } = useQuery<TodoPagination>({
  queryKey: ["todos", { filter }], // å‚æ•°åœ¨ä½¿ç”¨çš„åœ°æ–¹
});
refetch();
```

## placeholderData æœ‰ä»€ä¹ˆå¥½å¤„å‘¢ï¼Ÿ

`placeholderData` æ˜¯ä¸€ä¸ªå ä½ç¬¦æ•°æ®ï¼Œå½“ä½ è®¾ç½®ä¹‹åï¼Œå®ƒä¼šåœ¨æ¥å£è¿˜æ²¡è¿”å›çš„æ—¶å€™å±•ç¤ºå‡ºæ¥ã€‚

å¸¸ç”¨åœºæ™¯æœ‰ä¸¤ä¸ªï¼š

1. æ¥å£æœªè¿”å›æ—¶çš„å ä½ç¬¦æ•°æ®ã€‚
2. åˆ†é¡µåœºæ™¯æ—¶ï¼Œåˆ‡æ¢åˆ°å¦ä¸€ä¸ªé¡µç çš„é»˜è®¤æ•°æ®ã€‚

### åœºæ™¯ä¸€ï¼šæ¥å£æœªè¿”å›æ—¶çš„å ä½ç¬¦æ•°æ®

æˆ‘ä»¬å…ˆçœ‹ä¸€æ®µä»£ç ï¼š

```TypeScript
const useGetTodos = (position: string) => {
  const { filter } = useFilter();
  return useQuery<TodoPagination>({
    queryKey: ["todos", { filter }],
    queryFn: async () => {



      console.trace("useGetTodos position", position);
      return request.get("/todo", { params: { filter } });
    },
    // å ä½ç¬¦æ•°æ®
    placeholderData: () => {
      return {
        total: 222,
        list: [{ id: 0, name: "placeholderData", complete: false }],
      };
    },
  });
};
```

ä¸Šé¢è¿™æ®µä»£ç ï¼Œæ‰‹åŠ¨ç¡çœ  3sï¼Œåœ¨è¿™ 3s æœŸé—´ä¼šä½¿ç”¨é»˜è®¤çš„ placeholderData æ•°æ®ï¼Œä½†å½“æ¥å£è¿”å›ä¹‹åï¼Œä¼šå°† placeholderData æ•°æ®æ›¿æ¢æˆæ¥å£æ•°æ®ã€‚

Cache -> initial

query -> query

### åœºæ™¯äºŒï¼šåˆ†é¡µæ—¶ï¼Œåˆ‡æ¢é¡µç æ—¶çš„é»˜è®¤æ•°æ®

è¿˜æœ‰å¦å¤–ä¸€ä¸ªå¸¸è§çš„å°±æ˜¯**åˆ†é¡µåœºæ™¯**ï¼Œæ¯”å¦‚è¯´æˆ‘ä»¬ä»ç¬¬ 1 é¡µåˆ‡æ¢åˆ°ç¬¬ 2 é¡µæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ placeholderData è¿™ä¸ªapiï¼Œå…ˆå±•ç¤ºå‡ºæ¥ç›¸å…³çš„æ•°æ®ï¼ŒèƒŒåè¯·æ±‚æ¥å£ï¼Œç„¶åå†æŠŠ placeholderData æ•°æ®ç»™æ›¿æ¢æ‰ï¼Œè¿™æ ·å­å°±ä¸ä¼šå‡ºç°**ç¡¬åŠ è½½**çš„çŠ¶æ€äº†ã€‚

Todo æ”¯æŒæ ¹æ® Allã€Activeã€Completed ä¸‰ç§çŠ¶æ€è¿›è¡Œåˆ‡æ¢å±•ç¤ºå¯¹åº”çš„ Todoã€‚

```TypeScript
const useGetTodos = (position: string) => {
  const { filter } = useFilter();
  return useQuery<TodoPagination>({
    queryKey: ["todos", { filter }],
    queryFn: async () => {
      await sleep(3);
      console.trace("useGetTodos position", position, " è°ƒç”¨æ¥å£");
      return request.get("/todo", { params: { filter } });
    },
    placeholderData: keepPreviousData, // ä¸ä¼šç«‹å³ä¸¢å¼ƒå½“å‰çš„æ•°æ®ï¼Œè€Œæ˜¯ä¿ç•™æ—§æ•°æ®ï¼Œç›´åˆ°æ–°æ•°æ®å®Œå…¨åŠ è½½
  });
};
```

ä½†å¦‚æœä½¿ç”¨ placeholderData ä¹‹åï¼Œæ•ˆæœå°±æ˜¯ä»¥ä¸‹çš„æ•ˆæœï¼š**ä½¿ç”¨ä¸Šä¸€æ¬¡çš„ query ä½œä¸ºå ä½ç¬¦æ•°æ®ï¼Œç„¶åæ­¤æ—¶è°ƒç”¨æ¥å£æ‹‰å–æœ€æ–°çš„æ•°æ®ï¼Œç­‰åˆ°æ¥å£è¿”å›ä¹‹åå†æ›´æ–°åˆ—è¡¨é¡µã€‚**

## refetch vs invalidate

åœ¨ä½¿ç”¨æ•°æ®é‡æ–°è·å–ï¼Œå¯ä»¥ä½¿ç”¨ `query.refetch() / queryClient.refetchQueries()`ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨`queryClient.invalidateQueries()`ï¼Œè¿™ä¸¤ç§æ–¹å¼éƒ½å¯ä»¥ä½¿å¾—æ•°æ®å¤±æ•ˆé‡æ–°è°ƒç”¨æ¥å£ã€‚

> è¿™é‡Œç»Ÿç§°ä¸º refetch å’Œ invalidate

è¿™ä¸¤ä¸ªæœ‰å•¥åŒºåˆ«ï¼Ÿ

ä¸€å¥è¯æ€»ç»“ï¼šinvalidate æ˜¯æ›´åŠ æ™ºèƒ½çš„ refetchï¼Œå¯¹äºæ´»è·ƒ query ä¸¤ç§ api çš„ä½¿ç”¨å¹¶æ²¡æœ‰åŒºåˆ«ã€‚

ç¬¬ä¸€ä¸ªåŒºåˆ«ï¼šå¯¹äº `enabled: false`çš„ query

1. invalidate å¹¶ä¸ä¼šè°ƒç”¨ `enabled: false` çš„queryã€‚
2. refetch åˆ™å¯ä»¥è°ƒç”¨ `enabled: false` çš„ queryã€‚

ç¬¬äºŒä¸ªåŒºåˆ«ï¼šå¦‚æœ query æ²¡æœ‰è¢«æ¶ˆè´¹ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰ä»»ä½•ç»„ä»¶ä½¿ç”¨åˆ°è¯¥ query æ—¶

1. refetch è¿˜æ˜¯ä¼šç»§ç»­è°ƒç”¨è¯¥ query é‡æ–°è°ƒç”¨æ¥å£ã€‚
2. invalidate ä¸ä¼šè°ƒç”¨æ¥å£ï¼Œåªæœ‰å½“ç»„ä»¶é‡æ–°æŒ‚è½½æ—¶æ‰ä¼šè°ƒç”¨ã€‚

ä¸¾ä¸ªä¾‹å­ï¼š

æ·»åŠ ä¸€ä¸ªæŒ‰é’®æ¥åŠ¨æ€çš„æ˜¾ç¤º  todo åˆ—è¡¨ï¼š

Todo ç»„ä»¶ä¸­æœ‰ä¸¤ä¸ªåœ°æ–¹ä½¿ç”¨åˆ°äº†è¯¥ queryï¼Œå¦‚æœæˆ‘ç‚¹å‡»æŒ‰é’®ä¹‹åå‘¢ï¼ŸTodo ç»„ä»¶è¢«é”€æ¯ï¼Œè¯¥ query çš„æ¶ˆè´¹è€…å°±å˜æˆäº† 0ã€‚

æ­¤æ—¶æˆ‘ä»¬å†æ¥è°ƒç”¨ refetch å’Œ invalidate æ–¹æ³•ï¼Œå°±ä¼šå‘ç°

1.  refetch æ­£å¸¸è°ƒç”¨è¯¥ queryï¼Œquery æ•°æ®æ²¡æœ‰è¢«æ¶ˆè´¹ã€‚
2. invalidate æ–¹æ³•åˆ™ä¸ä¼šè°ƒç”¨ï¼Œåªæœ‰å½“ Todo ç»„ä»¶**å†æ¬¡æŒ‚è½½**æ—¶è‡ªåŠ¨è°ƒç”¨è¯¥ query ã€‚



## æ»šå‘€æ»šå‘€ï¼Œæˆ‘æ— é™åŠ è½½å‘€

useQuery ä¸­æä¾›æ— é™æ»šåŠ¨çš„hookï¼š`useInfiniteQuery`ï¼Œæ— éœ€æ‰‹åŠ¨å£°æ˜ page çš„çŠ¶æ€ã€‚

> Copy å®˜ç½‘çš„å£°æ˜

```TypeScript
const {
  fetchNextPage,
  fetchPreviousPage,
  hasNextPage,
  hasPreviousPage,
  isFetchingNextPage,
  isFetchingPreviousPage,
  ...result
} = useInfiniteQuery({
  queryKey,
  queryFn: ({ pageParam }) => fetchPage(pageParam),
  initialPageParam: 1,
  ...options,
  getNextPageParam: (lastPage, allPages, lastPageParam, allPageParams) =>
    lastPage.nextCursor,
})
```

### ä¸€ä¸ªå°ä¾‹å­

```TypeScript
  const { data, fetchNextPage, hasNextPage, isFetchingNextPage } = useInfiniteQuery({
    queryKey: ["scroll", "todos"],
    queryFn: async ({ pageParam }) => {
      return mockData(pageParam);
    },
    initialPageParam: 0,
    getNextPageParam: (lastPage, allPages, lastPageParam) => {
      if (lastPageParam + 1 > 5) {
        return undefined;
      }
      return lastPageParam + 1; // 1
    },
  });
  const allTodos = data?.pages.flat();
  
<button
 className="px-4 py-2 bg-gray-900 rounded-md text-white cursor-pointer"
 onClick={() => {
  fetchNextPage();
 }}
>
 {isFetchingNextPage ? "loading..." : "load more"}
</button>
```

è¿™é‡Œæœ‰å‡ ä¸ªæ˜¯å¿…ä¼ çš„å‚æ•°ï¼š

1. initialPageParamè¡¨ç¤ºåˆå§‹åŒ–çš„é¡µç å‚æ•°ï¼Œè¿™é‡Œä¼ å…¥ 0 ã€‚
2. queryFn ä¸­å¯ä»¥è§£æ„å‡ºæ¥ä¼ é€’çš„ pageParam å‚æ•°ã€‚
3. getNextPageParam è¡¨ç¤ºä¸‹ä¸€æ¬¡çš„é¡µç å‚æ•°ï¼Œå¦‚æœè¿”å›æ˜¯ undefinedã€null çš„è¯ï¼Œå°±è¡¨ç¤ºæ²¡æœ‰ä¸‹ä¸€é¡µï¼Œå¦‚æœæœ‰ä¸‹ä¸€é¡µçš„è¯ï¼Œè¿”å›ä¸‹ä¸€é¡µçš„é¡µç ã€‚
4. éœ€è¦æ³¨æ„çš„æ˜¯ `useInfiniteQuery`è¿”å›çš„ data æ˜¯ä¸€ä¸ªå¯¹è±¡æ•°ç»„ï¼š`{pageParams: params å‚æ•°æ•°ç»„, pages: æ•°æ®æ•°ç»„ }`ï¼Œæ¯”å¦‚è¯´ä¸Šé¢çš„ä¾‹å­ï¼Œå¦‚æœæˆ‘ä»¬è¯·æ±‚äº†ä¸¤é¡µï¼Œé‚£ä¹ˆ data çš„æ•°æ®æ˜¯ï¼š

```TypeScript
const data = {
 pageParams: [0, 1],
 pages: [ç¬¬0é¡µçš„æ•°æ®ï¼Œ ç¬¬1é¡µçš„æ•°æ®]
}
```

æ‰€ä»¥åœ¨å‰ç«¯éœ€è¦è¿›è¡Œ `data.pages.flat()`**æ‰å¹³ä¸€ä¸‹æ‰å¯ä»¥çœŸæ­£çš„ä½¿ç”¨**ã€‚

è¿™ä¹ˆä¸€è¯´ï¼Œå¯èƒ½æœ‰ç‚¹æ‡µï¼Œæˆ‘ä»¬å®é™…æ¼”ç»ƒä¸€ä¸‹ã€‚

å½“ç¬¬ä¸€æ¬¡åŠ è½½çš„æ—¶å€™ pageParam æ˜¯ 0ï¼Œ å®ƒæ˜¯ç”± `initialPagfeParam`å†³å®šçš„ã€‚

- è°ƒç”¨ `mockData(0)`
- è°ƒç”¨ `getNextPageParam`æŸ¥çœ‹æ˜¯å¦æœ‰ä¸‹ä¸€é¡µï¼š0 + 1 < 5ï¼Œæœ‰ä¸‹ä¸€é¡µï¼Œä¸‹ä¸€é¡µçš„é¡µç æ˜¯ 1ã€‚
- è¿”å›æ•°æ® `{ pageParams: [0], pages: [ç¬¬0é¡µçš„æ•°æ®] }`

ç‚¹å‡» button è°ƒç”¨ `fetchNextPage()`ï¼Œæ­¤æ—¶é¡µç æ˜¯ 1ï¼Œè¿™ä¸ªé¡µç æ˜¯ç”±ä¸Šä¸€æ¬¡ `getNextPageParam`å†³å®šçš„ ã€‚

- è°ƒç”¨ `mockData(1)`
- è°ƒç”¨ `getNextPageParam`æŸ¥çœ‹æ˜¯å¦æœ‰ä¸‹ä¸€é¡µï¼š1 + 1 < 5ï¼Œæœ‰ä¸‹ä¸€é¡µï¼Œä¸‹ä¸€é¡µçš„é¡µç æ˜¯ 2ã€‚
- è¿”å›æ•°æ® `{ pageParams: [0,1], pages: [ç¬¬0é¡µçš„æ•°æ®, ç¬¬1é¡µçš„æ•°æ®] }`

## è·å–å®Œæ•°æ®ä¹‹åï¼Œå¦‚ä½•å¤„ç†å‰¯ä½œç”¨

åœ¨ react query v5 è®¾è®¡ä¸­ï¼Œç§»é™¤æ‰äº† onSuccess ç­‰ç›¸å…³çš„å›è°ƒï¼Œé‚£å¦‚æœæˆ‘ä»¬å¯èƒ½éœ€è¦åŸºäºåç«¯æ•°æ®åšä¸€ç³»åˆ—çš„è¡ç”Ÿæ“ä½œï¼Œæˆ–è€…æœ‰å…¶ä»–çš„å‰¯ä½œç”¨ã€‚

```TypeScript
export function useTodos(filters) {
  const { dispatch } = useDispatch()

  const query = useQuery({
    queryKey: ['todos', 'list', { filters }],
    queryFn: () => fetchTodos(filters),
    staleTime: 2 * 60 * 1000,
  })

  useEffect(() => {
    if (query.data) {
      dispatch(setTodos(query.data))
    }
  }, [query.data])

  return query
}
```

ä¸‡èƒ½çš„ useEffect ï¼Œä¸ç”¨æ‹…å¿ƒ useEffect å¤šæ¬¡ï¼Œå®ƒçš„å¼•ç”¨ä¾èµ–æ˜¯ç¨³å®šçš„ã€‚

### åœºæ™¯ä¸€ï¼šReact Query çš„å¼‚æ­¥æ•°æ®éœ€è¦å­˜ä¸€ä»½åˆ° mobx ä¸­

Api å…¨éƒ¨äº¤ç»™ react query ç®¡ç†ä¹‹åï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦åœ¨ mobx ä¸­å­˜å¼‚æ­¥æ•°æ®æ€ä¹ˆåŠï¼Œæˆ–è€…è¯´ mobx ä¸­è¯»å– react query çš„æ•°æ®ã€‚

è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨ react query è°ƒç”¨ apiï¼Œæ–°å»ºä¸€ä¸ª storeï¼Œç„¶åé€šè¿‡ useEffect å°†å¼‚æ­¥æ•°æ®åŒæ­¥ç»™ storeï¼Œä¿è¯ä¸¤ä»½æ•°æ®çš„ä¸€è‡´æ€§ã€‚

1. æ–°å»ºä¸€ä¸ª react query çš„ hook

```TypeScript
const useGetUser = (params) => {
  return useQuery({
    ...options,
    queryKey: [ClientAssetService.GetUser, params],
    queryFn: () => getUser(params),
    staleTime: 1000 * 60,
    placeholderData: keepPreviousData,
  });
};
```

2. æ–°å»ºä¸€ä¸ª mobx store

```TypeScript
class UserStore {
  constructor() {
    makeAutoObserver(this);
  }
}
```

3. åœ¨ä½¿ç”¨çš„åœ°æ–¹é€šè¿‡ useEffect å°† react query æ•°æ®åŒæ­¥åˆ° mobx storeï¼Œä¿è¯ä¸¤ä»½æ•°æ®çš„ä¸€è‡´æ€§ã€‚

```TypeScript
const Layout = () => {
  const { data } = useGetUser();

  // ç›‘å¬ data å˜åŒ–ï¼ŒåŒæ­¥ç»™ mobx
  useEffect(() => {
    useStore.updateUser(data);
  }, [data]);

};
```

## å¦‚ä½•åŒæ­¥çš„æ”¹ react query ç¼“å­˜

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `getQueryData()`ã€`setQueryData()`çš„æ–¹å¼æ¥åŒæ­¥çš„æ”¹ react query ç¼“å­˜ã€‚ `setQueryData`æ˜¯ä¸€ä¸ªåŒæ­¥å‡½æ•°ï¼Œå¯ç”¨äºç«‹å³æ›´æ–°æŸ¥è¯¢çš„ç¼“å­˜æ•°æ®ã€‚å¦‚æœæŸ¥è¯¢ä¸å­˜åœ¨ï¼Œåˆ™ä¼šåˆ›å»ºå®ƒã€‚å¦‚æœæŸ¥è¯¢é’©å­åœ¨é»˜è®¤çš„ 5 åˆ†é’Ÿå†…æ²¡æœ‰ä½¿ç”¨è¯¥æŸ¥è¯¢`gcTime`ï¼Œåˆ™è¯¥æŸ¥è¯¢å°†è¢«åƒåœ¾æ”¶é›†ã€‚è¦ä¸€æ¬¡æ›´æ–°å¤šä¸ªæŸ¥è¯¢å¹¶éƒ¨åˆ†åŒ¹é…æŸ¥è¯¢é”®ï¼Œæ‚¨éœ€è¦ä½¿ç”¨`queryClient.setQueriesData()`ã€‚

```TypeScript
queryClient.setQueryData(queryKey, updater)
```

`getQueryData`æ˜¯ä¸€ä¸ªåŒæ­¥å‡½æ•°ï¼Œå¯ç”¨äºè·å–ç°æœ‰æŸ¥è¯¢çš„ç¼“å­˜æ•°æ®ã€‚å¦‚æœæŸ¥è¯¢ä¸å­˜åœ¨ï¼Œ`undefined`å°†è¿”å›ã€‚

```TypeScript
const data = queryClient.getQueryData(queryKey)
```

æœ‰äº†è¿™ä¸¤ä¸ª apiï¼Œ**å¯ä»¥åœ¨ mobx ä¸­è®¿é—®ã€æ›´æ–° react query çš„æ•°æ®**ã€‚



## é”™è¯¯å¤„ç†

### å…ˆå†³æ¡ä»¶

React Query éœ€è¦ä¸€ä¸ªè¢«æ‹’ç»çš„ Promise æ‰èƒ½æ­£ç¡®å¤„ç†é”™è¯¯ï¼Œaxios å¯¹äº**ä¸æˆåŠŸçš„ http ä¼šè‡ªåŠ¨æŠ›å‡ºé”™è¯¯**ã€‚

å¦‚æœä½¿ç”¨çš„ fetch å…¶ä»–åº“*ä¸ä¼š*åœ¨é”™è¯¯çŠ¶æ€ä»£ç ï¼ˆå¦‚ 4xx æˆ– 5xxï¼‰ä¸Šç»™æ‚¨æ‹’ç»çš„ Promiseï¼Œåˆ™å¿…é¡»åœ¨`queryFn` ä¸­æŠ›å‡ºé”™è¯¯ã€‚

```TypeScript
const { error } = useQuery({
  queryKey: ['todos', todoId],
  queryFn: async () => {
    if (somethingGoesWrong) {
      throw new Error('Oh no!')
    }
    if (somethingElseGoesWrong) {
      return Promise.reject(new Error('Oh no!'))
    }

    return data
  },
})
```

React Query ä¸­å¤„ç†é”™è¯¯çš„ä¸‰ç§ä¸»è¦æ–¹æ³•æ˜¯ï¼š

- `isError`ï¼šä» useQuery è¿”å›çš„å±æ€§
- å›è°ƒ`onError`ï¼ˆåœ¨æŸ¥è¯¢æœ¬èº«æˆ–å…¨å±€ QueryCache / MutationCache ä¸Šï¼‰
- ä½¿ç”¨ `ErrorBoundary`

### æ ‡å‡†å¤„ç†

```TypeScript
function TodoList() {
  const {
    data: todos,
    isPending,
    isFetching,
    isError,
    ...rest
  } = useGetTodos("List");

  if (isPending) {
    return <div className="mt-5 sm:mt-7 bg-white p-6">loading...</div>;
  }

  if (isError) {
    return <div>An error occurred</div>;
  }

  return (
    <div>
      {todos.data.map((todo) => (
        <Todo key={todo.id} {...todo} />
      ))}
    </div>
  )
}
```

åœ¨è¿™é‡Œï¼Œé€šè¿‡æ£€æŸ¥React Query æä¾›ç»™çš„`isError`å¸ƒå°”æ ‡å¿—ï¼ˆä»æšä¸¾æ´¾ç”Ÿï¼‰æ¥å¤„ç†é”™è¯¯æƒ…å†µ

è¿™å¯¹äºæŸäº›åœºæ™¯æ¥è¯´å½“ç„¶æ²¡é—®é¢˜ï¼Œä½†ä¹Ÿæœ‰ä¸€äº›ç¼ºç‚¹ï¼š

1. å®ƒä¸èƒ½å¾ˆå¥½åœ°å¤„ç†åå°é”™è¯¯ï¼šæˆ‘ä»¬çœŸçš„æƒ³ä»…ä»…å› ä¸ºåå°é‡æ–°è·å–å¤±è´¥å°±å¸è½½å®Œæ•´çš„å¾…åŠäº‹é¡¹åˆ—è¡¨å—ï¼Ÿä¹Ÿè®¸ API æš‚æ—¶å…³é—­ï¼Œæˆ–è€…æˆ‘ä»¬è¾¾åˆ°äº†é€Ÿç‡é™åˆ¶ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒå¯èƒ½ä¼šåœ¨å‡ åˆ†é’Ÿåå†æ¬¡å·¥ä½œã€‚
2. å¦‚æœå¿…é¡»åœ¨æ¯ä¸ªæƒ³è¦ä½¿ç”¨æŸ¥è¯¢çš„ç»„ä»¶ä¸­æ‰§è¡Œæ­¤æ“ä½œï¼Œé‚£ä¹ˆå®ƒå¯èƒ½ä¼šå˜å¾—ç›¸å½“æ ·æ¿åŒ–ã€‚

### ErrorBoundary

ä½¿ç”¨ ErrorBoundary ç”¨äºæ•è·æ¸²æŸ“æœŸé—´å‘ç”Ÿçš„è¿è¡Œæ—¶é”™è¯¯ï¼Œèƒ½å¤Ÿå¯¹å®ƒä»¬åšå‡ºæ­£ç¡®çš„ååº”å¹¶æ˜¾ç¤ºå›é€€ UIã€‚

```TypeScript
function App() {
  return (
    <ErrorBoundary fallbackRender={() => <div>ErrorBoundary</div>}>
      <QueryClientProvider client={queryClient}>
        <TodoApp />
        <ReactQueryDevtools initialIsOpen={false} />
      </QueryClientProvider>
    </ErrorBoundary>
  );
}
```

*ErrorBoundary æ— æ³•*åšçš„ä¸€ä»¶äº‹æ˜¯æ•è·å¼‚æ­¥é”™è¯¯ï¼Œå› ä¸ºè¿™äº›é”™è¯¯ä¸ä¼šåœ¨æ¸²æŸ“æœŸé—´å‘ç”Ÿã€‚å› æ­¤ï¼Œä¸ºäº†ä½¿é”™è¯¯è¾¹ç•Œåœ¨ React Query ä¸­å·¥ä½œï¼ŒReact Query æä¾›äº†ä¸€ä¸ªå­—æ®µ `throwOnError`ï¼Œä¼šåœ¨å†…éƒ¨ä¸ºæ‚¨æ•è·é”™è¯¯å¹¶åœ¨ä¸‹ä¸€ä¸ªæ¸²æŸ“å‘¨æœŸä¸­é‡æ–°æŠ›å‡ºé”™è¯¯ï¼Œä»¥ä¾¿é”™è¯¯è¾¹ç•Œå¯ä»¥æ‹¾å–å®ƒã€‚

```TypeScript
useQuery({
  queryKey: ['todos'],
  queryFn: fetchTodos,
  // ğŸš€ å¦‚æœ error çš„çŠ¶æ€ç å¤§äº 500ï¼Œå°±æŠ›å‡ºé”™è¯¯
  throwOnError: (error) => error.response?.status >= 500,
})
```

### å…¨å±€å›è°ƒ

åˆ›å»ºæ—¶éœ€è¦æä¾›å…¨å±€å›è°ƒ`QueryCache`ï¼Œè¿™åœ¨åˆ›å»ºæ—¶éšå¼å‘ç”Ÿ`new QueryClient`ï¼Œä½†æ‚¨ä¹Ÿå¯ä»¥è‡ªå®šä¹‰ï¼š

```TypeScript
const queryClient = new QueryClient({
  queryCache: new QueryCache({
    onError: (error) =>
      toast.error(`error: ${error.message}`),
  }),
})
```

ç°åœ¨ï¼Œæ¯ä¸ªæŸ¥è¯¢åªä¼šæ˜¾ç¤ºä¸€æ¬¡é”™è¯¯æç¤ºï¼Œè¿™æ­£æ˜¯æˆ‘ä»¬æƒ³è¦çš„ã€‚ğŸ¥³å®ƒä¹Ÿå¯èƒ½æ˜¯æ”¾ç½®æ‚¨æƒ³è¦æ‰§è¡Œçš„ä»»ä½•ç±»å‹çš„é”™è¯¯è·Ÿè¸ªæˆ–ç›‘è§†çš„æœ€ä½³ä½ç½®ï¼Œå› ä¸ºå®ƒä¿è¯æ¯ä¸ªæŸ¥è¯¢ä»…è¿è¡Œä¸€æ¬¡è¯·æ±‚å¹¶ä¸”*ä¸èƒ½*åƒé»˜è®¤é€‰é¡¹ä¸€æ ·è¢«è¦†ç›–ã€‚
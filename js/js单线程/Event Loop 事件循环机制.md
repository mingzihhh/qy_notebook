## Event Loop 事件循环机制

https://zhuanlan.zhihu.com/p/33058983

https://juejin.im/post/5be5a0b96fb9a049d518febc

**Event Loop是JS的事件执行机制**，一种用于管理和调度异步任务执行的机制。它使得 JS 可以处理异步操作，如定时器、事件处理、网络请求等，而不会阻塞主线程的执行。

H5 web worker标准：

允许JavaScript脚本创建多个线程，但是子线程完全受主线程控制，且不得操作DOM。本质还是单线程，**为了保证操作一致性**



注：

JavaScript 单线程指的是浏览器中负责解释和执行 JavaScript 代码的只有一个线程，即为**JS引擎线程**，但是浏览器的渲染进程是提供多个线程的，如下：

- JS引擎线程
- 事件触发线程
- 定时触发器线程
- 异步http请求线程
- GUI渲染线程

当遇到计时器、DOM事件监听或者是网络请求的任务时，JS引擎会将它们直接交给 web api，也就是浏览器提供的相应线程（如定时器线程为setTimeout计时、异步http请求线程处理网络请求）去处理，而JS引擎线程继续后面的其他任务，这样便实现了 **异步非阻塞**。



#### 执行栈，事件队列和事件循环

执行栈可以认为是一个存储函数调用的**栈结构**，遵循先进后出的原则。

事件队列中存放异步事件的回调函数。

（异步：网络请求，事件监听，定时器。。）

异步执行：

1. js引擎遇到一个异步事件后会将这个事件挂起，继续执行执行栈中的其他任务。

2. 当一个异步事件返回结果后，js会将这个事件加入与当前执行栈不同的另一个队列，我们称之为**事件队列**，具体可以分为**宏任务队列（Task Queue）和 微任务队列（Microtask Queue）**，

3. 一旦"执行栈"中的所有同步任务执行完毕，系统就会读取"事件队列"，看看里面有哪些事件。那些对应的异步任务，于是结束等待状态，进入执行栈，开始执行。

   主线程从"事件队列"中读取事件，这个过程是循环不断的，所以整个的这种运行机制又称为**Event Loop（事件循环）**

![img](https://pic4.zhimg.com/80/v2-da078fa3eadf3db4bf455904ae06f84b_hd.jpg)

"事件队列"中的事件，除了IO设备的事件以外，还包括一些用户产生的事件（比如鼠标点击、页面滚动等等）。只要指定过回调函数，这些事件发生时就会进入"任务队列"，等待主线程读取。

所谓"回调函数"（callback），就是那些会被主线程挂起来的代码。异步任务必须指定回调函数，当主线程开始执行异步任务，就是执行对应的回调函数。

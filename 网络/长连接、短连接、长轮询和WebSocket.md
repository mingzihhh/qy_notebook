# 长连接、短连接、长轮询和段轮询

<https://www.cnblogs.com/gotodsp/p/6366163.html>

<https://cloud.tencent.com/developer/article/1076547>

HTTP的长连接和短连接本质上是**TCP长连接和短连接**。

HTTP属于应用层协议，在传输层使用TCP协议，在网络层使用IP协议。 IP协议主要解决网络路由和寻址问题，TCP协议主要解决如何在IP层之上可靠地传递数据包，使得网络上接收端收到发送端所发出的所有包，并且顺序与发送顺序一致。TCP协议是可靠的、面向连接的。

### 短连接

**在HTTP/1.0中默认使用短连接**。也就是说，客户端和服务器每进行一次HTTP操作，就建立一次连接，任务结束就中断连接。当客户端浏览器访问的某个HTML或其他类型的Web页中包含有其他的Web资源（如JavaScript文件、图像文件、CSS文件等），每遇到这样一个Web资源，浏览器就会重新建立一个HTTP会话。

**优点**：管理起来比较简单，存在的连接都是有用的连接，不需要额外的控制手段。

**缺点**：如果客户请求频繁，将在TCP的建立和关闭操作上浪费时间和带宽。

**适用场景**：并发量大，但每个用户无需频繁操作的情况。如WEB网站的http服务，因为长连接对于服务端来说会耗费一定的资源



### 长连接

**从HTTP/1.1起，默认使用长连接**，用以保持连接特性。使用长连接的HTTP协议，会在响应头加入这行代码：

```
Connection:keep-alive
```

在使用长连接的情况下，当一个网页打开完成后，客户端和服务器之间用于传输HTTP数据的TCP连接不会关闭，客户端再次访问这个服务器时，会继续使用这一条已经建立的连接。

Keep-Alive 不会永久保持连接，它有一个保持时间，可以在不同的服务器软件（如Apache）中设定这个时间。实现长连接需要客户端和服务端都支持长连接。

**优点**：长连接可以省去较多的TCP建立和关闭的操作，减少浪费，节约时间。对于频繁请求资源的客户端适合使用长连接

**缺点**：服务器维护一个长连接会增加开销。

**适用场景**：操作频繁，点对点的通讯，而且连接数不能太多



### 短轮询

浏览器每隔一段时间向浏览器发送http请求，服务器端在收到请求后，不论是否有数据更新，都直接进行响应。通过让客户端不断的进行请求，使得客户端能够模拟实时地收到服务器端的数据的变化。

**优点**：实现简单，易于理解

**缺点**：需要不断的建立http连接，严重浪费了服务器端和客户端的资源。

不适用于那些同时在线用户数量比较大，并且很注重性能的Web应用

```
var xhr = new XMLHttpRequest();
setInterval(function(){
    xhr.open('GET','/user');
    xhr.onreadystatechange = function(){
	};
	xhr.send();
},1000)
```



### 长轮询

当服务器收到客户端发来的请求后,服务器端不会直接进行响应，而是先将这个请求挂起，然后判断服务器端数据是否有更新。如果有更新，则进行响应，如果一直没有数据，则到达一定的时间限制(服务器端设置)才返回。

客户端JavaScript响应处理函数会在处理完服务器返回的信息后，再次发出请求，重新建立连接。

**优点**：减少了很多不必要的http请求次数，节约了资源

**缺点**：连接挂起也会导致资源的浪费

```
   function ajax(){
        var xhr = new XMLHttpRequest();
        xhr.open('GET','/user');
        xhr.onreadystatechange = function(){
              ajax();
        };
        xhr.send();
    }
```





### 长短轮询和长短连接的区别

1. 决定的方式

   一个TCP连接是否为长连接，是通过设置HTTP的Connection Header来决定的，而且是需要两边都设置才有效。而一种轮询方式是否为长轮询，是根据服务端的处理方式来决定的，与客户端没有关系。

2. 实现的方式

   连接的长短是通过协议来规定和实现的。而轮询的长短，是服务器通过编程的方式手动挂起请求来实现的。


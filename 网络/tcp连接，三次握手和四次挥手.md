## tcp连接，三次握手和四次挥手

### tcp连接

tcp连接的端点是套接字（socket)

socket = ( ip地址 ：端口号)

每一条tcp连接唯一的被通信两端的两个套接字所确定



### 三次握手



![](https://upload-images.jianshu.io/upload_images/15055044-9fd60414e63c289a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/webp)

**HTTP中TCP连接的建立需要经历以下三个过程**：
1、客户端向服务器发送一个建立连接的请求；
2、服务器接到请求后发送同意连接的信号；(客户端建立连接）
3、客户端接到同意连接的信号后，再次向服务器发送了确认信号，“握手”结束。（服务器建立连接，第三次可以携带数据）



三次握手之所以是三次是保证client和server均让对方知道自己的接收和发送能力没问题而保证的最小次数。

第一次client => server 只能server判断出client具备发送能力
第二次 server => client client就可以判断出server具备发送和接受能力。

此时client还需让server知道自己接收能力没问题于是就有了第三次 

第三次 client => server 双方均保证了自己的接收和发送能力没有问题



### 为什么需要进行三次握手，而不是两次握手

**因为两次握手不可靠，三次握手可以防止失效的连接请求报文段被服务端接收，产生错误。**

如果client发出的第一个连接请求报文段并没有丢失，而是在某个网络结点长时间的滞留了，以致延误到连接释放以后的某个时间才到达server。本来这是一个早已失效的报文段。但server收到此失效的连接请求报文段后，就误认为是client再次发出的一个新的连接请求。于是就向client发出确认报文段，同意建立连接。

假设不采用“三次握手”，那么只要server发出确认，新的连接就建立了。由于现在client并没有发出建立连接的请求，因此不会理睬server的确认，也不会向server发送数据。但server却以为新的运输连接已经建立，并一直等待client发来数据。这时两次握手已经完成，两端就建立起一个无效的连接。但浏览器认为自己没发出请求，所以不会回应，这样就让服务器白白等待回应，浪费了服务器资源。而三次握手的机制下，浏览器知道自己并没有请求连接，会发送拒绝包给服务器，服务器收到回应后也会结束这次无效的连接。



### 四次挥手

![](https://upload-images.jianshu.io/upload_images/15055044-7621b9fe2efb72ae.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/webp)

**解除连接需要四个过程**：
1、主机向服务器发送一个断开连接的请求
2、服务器接到请求后发送确认收到请求的信号
3、服务器向主机发送断开通知
4、主机接到断开通知后断开连接并反馈一个确认信号，服务器收到确认信号后断开连接；



#### 为什么需要“四次挥手”

第一次挥手是浏览器发完数据后，发送FIN请求断开连接。
 第二次挥手是服务器发送ACK表示同意，但考虑到服务器可能还有数据要发送，所以服务器先发送确认信号，等所有数据发送完毕后再同意断开。
 简而言之，一端断开连接需要两次挥手（请求和回应），两端断开连接就需要四次挥手了。



#### 为什么第四次握手后，主机发送确认信号后并没有立即断开连接，而是等待了 2 个报文传送周期

1. 为了确保主机发送的最后一个ACK报文段能够到达服务器

   如果第四次挥手的确认信息丢失，服务器将会重新发送第三次握手的断开连接的信号，而服务器发觉丢包与重新发送的断开连接到达主机的时间正好为 2 个报文传输周期。

2. 为了防止失效的连接请求报文段出现在本次连接中

   等待两个报文传送周期，本连接持续时间中产生的所有报文段都从网络中消失
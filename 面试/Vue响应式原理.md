## Vue响应式原理

##### 响应式原理

基于数据劫持的双向绑定

要点

1. 使用 Object.defineProperty 把对象属性全部转为 getter/setter；通过每个组件实例相应的watcher对象，在组件渲染的过程中把“接触”过的数据属性记录为依赖。当属性被访问和修改时通知watcher变化，使组件更新。(**如何追踪变化**)

2. Vue 不能检测到对象属性的添加或删除，原因是vue在初始化实例时对属性执行getter/setter转化，解决方法是手动调用 Vue.set 或者 this.$set（**检测变化的注意事项**）

3. Vue 不允许动态添加根级响应式属性，所以你必须在初始化实例前声明根级响应式属性（**声明响应式属性**）

4. Vue **异步**执行 DOM 更新。只要观察到数据变化，Vue 将开启一个队列，并缓冲在同一事件循环中发生的所有数据改变。如果同一个 watcher 被多次触发，只会被推入到队列中一次。这种在缓冲时去除重复数据对于避免不必要的计算和 DOM 操作是非常重要的。然后，在下一个的事件循环“tick”中，Vue 刷新队列并执行实际 (已去重的) 工作。

   想获得更新后的 DOM 状态，可以在数据变化之后立即使用 `Vue.nextTick(callback)`。这样回调函数将在 DOM 更新完成后被调用。

   

Vue 内部使用了 `Object.defineProperty()` 来实现数据响应式，通过这个函数可以监听到 `set` 和 `get` 的事件。

（ Object.defineProperty() 方法会直接在一个对象上定义一个新属性，或者修改一个对象的现有属性， 并返回这个对象。**存取描述符**，访问属性执行get，修改属性执行set）



 Vue 组件挂载时添加响应式的过程。在组件挂载时，会先对所有需要的属性调用 `Object.defineProperty()`，然后实例化 `Watcher`，传入组件更新的回调。在实例化过程中，会对模板中的属性进行求值，触发依赖收集。在 `get` 中收集依赖，在 `set` 派发更新。